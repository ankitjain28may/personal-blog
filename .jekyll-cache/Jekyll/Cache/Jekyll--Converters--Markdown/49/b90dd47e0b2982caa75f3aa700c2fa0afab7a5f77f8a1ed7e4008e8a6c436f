I")0<p>One of the struggles that developers face when moving to Drupal 8 is the lack of best practices in deploying Drupal sites. The Challenges in deployment- Dependency Management, Drupal Contrib Modules/Themes, Configuration Management and of course Code Base. Drupal 7 has no such problems. Ahhh, Drupal 8 comes with lots of stuff to manage. One of the biggest change in Drupal 8 is the adoption of Composer. Good things come at a price.</p>

<p>We will use one codebase for one Drupal site and use git for version control and deployment.</p>

<h2 id="composer"><strong>Composer</strong></h2>

<p><a href="https://getcomposer.org/">Composer</a> is a dependency manager for PHP (like npm for Node, pip for Python). Drupal core uses Composer to manage core dependencies like Symfony components and Guzzle. Composer allows us to systematically manage a list of dependencies and their subsidiary dependencies. Composer install these dependencies via a manifest file called as composer.json.</p>

<p><img src="/mediumish-theme-jekyll/assets/drupal/inline-images/Firefox_Screenshot_2018-04-22T18-49-10.848Z_0.png" alt="Composer workflow" /></p>

<p>This composer.json file contains the dependencies that the project requires which is installed by running -</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer install
</code></pre></div></div>

<p>for the first time. It locates, downloads, validates and loads the packages. It also ensures that exactly the right versions for each package are used and maintains the log file called composer.lock.</p>

<p><strong>Note: Always Commit your composer.lock file</strong> because it contains the exact version of the dependencies that you have defined in the project.</p>

<p>If you want to update any specific package, it’s a good practice to run this command -</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer update package/package-name
</code></pre></div></div>

<p>You should never run <strong>composer update</strong> because composer will try to update every single dependency which can cause problems to your site.</p>

<h2 id="drupal-composer"><strong>Drupal Composer</strong></h2>

<p><a href="https://github.com/drupal-composer/drupal-project">drupal-composer/drupal-project</a> is the life-saver project for managing your site dependencies with Composer.</p>

<p>To install this project template, Run this command -</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer create-project drupal-composer/drupal-project:8.x-dev drupal8 --stability dev --no-interaction
</code></pre></div></div>

<p>It will automatically install a Drupal site with all the dependencies and also install <a href="https://drupalconsole.com/">Drupal console</a> and <a href="https://github.com/drush-ops/drush">Drush</a> locally.</p>

<p>Composer is one of the fastest ways to install dependencies as it caches the dependencies and next time loads data from the cache.</p>

<p><strong>Directory Structure:</strong></p>

<p><img src="/mediumish-theme-jekyll/assets/drupal/inline-images/Firefox_Screenshot_2018-04-22T19-45-24.606Z.png" alt="Directory structure" /></p>

<p>It is different from the Drupal directory structure. You can resemble web directory with the public directory which contains Drupal files. All third party dependencies are outside the web folder.</p>

<p>You can install any Drupal Modules, themes, and profiles through composer which will be downloaded in the contrib folder inside the modules, themes, profiles respectively. In this way, composer.lock file will have a record of all the Drupal contrib modules along with the third party dependencies.</p>

<p>To download any modules, themes using composer-</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require drupal/mediumish_blog

# For installing theme, we will use drupal console

drupal theme:install mediumish_blog
</code></pre></div></div>

<p><strong>Gitignore:</strong></p>

<p>As all the dependencies and Drupal contrib modules, themes are managed by composer so we will not push these content to git.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Ignore directories generated by Composer  
/drush/contrib  
/vendor/  
/web/core/  
/web/modules/contrib/  
/web/themes/contrib/  
/web/profiles/contrib/  
/web/libraries/

# Ignore sensitive information  
/web/sites/*/settings.php  
/web/sites/*/settings.local.ph
</code></pre></div></div>
<h2 id="configuration-management"><strong>Configuration Management</strong></h2>

<p>Deployment and configuration management are common actions of a project life cycle. We have installed various modules and configure our local site but our production site has no such configuration.</p>

<p>In Drupal 7, we have features module which is used to sync configuration. But Drupal 8 has an inbuilt solution for managing configurations which allows you to export complete website configurations and store them in YAML files. Exported files can be imported to another website to get the same result. Drupal’s configuration system helps to solve the config files synchronization problem in two ways: a unified way to store configuration and a process to import/export changes between instances of the same site.</p>

<p><strong>How to synchronize config files</strong></p>

<p>Open /web/sites/default/settings.php and set $config_directories[‘sync’]</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$config_directories['sync'] = '../config/sync';
</code></pre></div></div>

<p>It’s good practice to store config files outside of the web directory to avoid making them accessible from the Internet.</p>

<p>Now Use Drupal console to export the configuration -</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>drupal config:export

# import on prod server

drupal config:import
</code></pre></div></div>

<p><strong>Note:</strong> It is required that both the production and local Drupal site should have same UUIDs<strong>.</strong> <a href="https://www.drupal.org/docs/8/configuration-management/managing-your-sites-configuration">More info</a></p>

<p><strong>Note:</strong> Drupal configuration management has a bug i.e custom blocks’ data neither be imported nor be exported.<a href="https://www.drupal.org/project/drupal/issues/2756331">Issue Link</a></p>

<h2 id="git"><strong>Git</strong></h2>

<p>We will use git to add, commit and push the local site’s data with all the configuration which will be pulled from the prod server/site. Let’s see the flow-</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Local

git add .

git commit -m"Add commit message"

git push origin HEAD

# Server

git pull otigin HEAD

composer install                         # to install any new dependencies, drupal contrib modules, themes

drupal config:import                   # to import the configuration

drupal cache:rebuild all              # rebuild the cache
</code></pre></div></div>

<p><strong>Update Modules, themes, and profiles</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer update drupal/mediumish_blog

drupal update:execute mediumish_blog

drupal update:execute all
</code></pre></div></div>

<p><strong>Update Drupal Core</strong></p>

<p>Generally, we face problems in updating Drupal core, composer has a simple way to manage this too-</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer update drupal/core --with-dependencies
</code></pre></div></div>

<p>It will update the  Drupal core and all its associated dependencies.</p>

<h2 id="managing-environment-configuration"><strong>Managing Environment Configuration</strong></h2>

<p>The best part that I was looking for as a developer in Drupal is managing different environment configuration. This can be done by using <a href="https://github.com/vlucas/phpdotenv">vlucas</a><a href="https://github.com/vlucas/phpdotenv">/</a><a href="https://github.com/vlucas/phpdotenv">phpdotenv</a> module which also comes with drupal composer template.</p>

<p>Anything that is likely to change between deployment environments – such as database credentials or credentials for 3rd party services – should be extracted from the code into environment variables Basically, a <code class="language-plaintext highlighter-rouge">.env</code> file is an easy way to load custom configuration variables that your application needs without having to modify any other files.</p>

<p>Rename .env.example to .env file and add all the credentials as a key-value pair in .env file.</p>

<p>load.environment.php file in the root will load this .env file and make it available for you.</p>

<p><strong>How to</strong> <strong>use .</strong><strong>env file</strong></p>

<p>Open /web/sites/default/setting.php and add this set of code-</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$databases['default']['default'] = [  
  'database' =&gt; getenv('MYSQL_DATABASE'),  
  'driver' =&gt; 'mysql',  
  'host' =&gt; getenv('MYSQL_HOSTNAME'),  
  'namespace' =&gt; 'Drupal\\Core\\Database\\Driver\\mysql',  
  'password' =&gt; getenv('MYSQL_PASSWORD'),  
  'port' =&gt; getenv('MYSQL_PORT'),  
  'prefix' =&gt; '',  
  'username' =&gt; getenv('MYSQL_USER'),  
];
</code></pre></div></div>

<p>Open .env file and sets credentials-</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MYSQL_DATABASE='db_name'  
MYSQL_HOSTNAME='localhost'  
MYSQL_PASSWORD='secret'  
MYSQL_PORT='3306'  
MYSQL_USER='root'
</code></pre></div></div>

<p>Now as all our credentials are stored in .env file, we can push our settings.php to the server and manage its configuration through .env file.</p>

<p>We generally enable twig debugging while development and disable on production, This can also be done easily and smoothly through a .env file.</p>

<p>Add new key value pair in .env file-</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>APP_ENV='local'
</code></pre></div></div>

<p>Now copy web/sites/example.settings.local.php to web/sites/default/settings.local.php and add this code in web/sites/development.services.yml under parameters </p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>twig.config:  
    debug: true  
    auto_reload: true  
    cache: false
</code></pre></div></div>

<p>Now open web/sites/default/settings.php and add this code-</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$env = getenv('APP_ENV');

$base_path = $app_root . '/' . $site_path;  
$settingsFile = $base_path . '/settings.' . $env . '.php';

if (file_exists($settingsFile)) {  
  include $settingsFile;  
}
</code></pre></div></div>

<p>So, in this way, if you set your APP_ENV=’local’, Twig debug will be enabled and on production, you can disable by setting APP_ENV=’prod’. You can also configure different configuration for different environments.</p>

<h2 id="conclusion"><strong>Conclusion</strong></h2>

<p>Drupal 8 offers a built-in solution for exporting and importing site configurations which is way better than what you can do in D7. Dependencies and contrib modules/themes are managed by the composer itself. It’s not yet perfect, there is no standard approach, but the workflow described above is a simple and efficient solution. You can define your own workflow based on your need.</p>

<p>For reference, I have pushed code to repo- Here its link - <a href="https://github.com/ankitjain28may/drupal-best-practices">drupal-best-practices</a></p>

<p>I hope you have found this article useful. I would love to hear your feedback :)</p>
:ET